version: "3.8"

networks:
  tambo_network:
    driver: bridge

volumes:
  tambo_node_modules:
  tambo_api_dist:
  tambo_web_next:

services:
  # Web Service (Next.js)
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    container_name: tambo_web
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_SUPABASE_URL=${SUPABASE_URL:-http://localhost:8000}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - NEXT_PUBLIC_TAMBO_API_URL=${NEXT_PUBLIC_TAMBO_API_URL:-http://localhost:3001}
      - NEXT_PUBLIC_TAMBO_API_KEY=${NEXT_PUBLIC_TAMBO_API_KEY}
      - NEXT_PUBLIC_POSTHOG_HOST=${NEXT_PUBLIC_POSTHOG_HOST}
      - NEXT_PUBLIC_POSTHOG_KEY=${NEXT_PUBLIC_POSTHOG_KEY}
      - DATABASE_URL=${DATABASE_URL}
      - API_KEY_SECRET=${API_KEY_SECRET}
      - PROVIDER_KEY_SECRET=${PROVIDER_KEY_SECRET}
      - RESEND_API_KEY=${RESEND_API_KEY}
      - RESEND_AUDIENCE_ID=${RESEND_AUDIENCE_ID}
      - WEATHER_API_KEY=${WEATHER_API_KEY}
      - COMPOSIO_API_KEY=${COMPOSIO_API_KEY}
      - ALLOW_LOCAL_MCP_SERVERS=${ALLOW_LOCAL_MCP_SERVERS}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
    depends_on:
      - api
    networks:
      - tambo_network
    restart: unless-stopped
    volumes:
      - tambo_web_next:/app/apps/web/.next
      - tambo_node_modules:/app/node_modules

  # API Service (NestJS)
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    container_name: tambo_api
    ports:
      - "3001:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - DATABASE_URL=${DATABASE_URL}
      - API_KEY_SECRET=${API_KEY_SECRET}
      - PROVIDER_KEY_SECRET=${PROVIDER_KEY_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - EXTRACTION_OPENAI_API_KEY=${EXTRACTION_OPENAI_API_KEY}
      - FALLBACK_OPENAI_API_KEY=${FALLBACK_OPENAI_API_KEY}
      - RESEND_API_KEY=${RESEND_API_KEY}
      - RESEND_AUDIENCE_ID=${RESEND_AUDIENCE_ID}
      - LANGFUSE_PUBLIC_KEY=${LANGFUSE_PUBLIC_KEY}
      - LANGFUSE_SECRET_KEY=${LANGFUSE_SECRET_KEY}
      - LANGFUSE_HOST=${LANGFUSE_HOST}
      - LIBRETTO_API_KEY=${LIBRETTO_API_KEY}
      - SLACK_OAUTH_TOKEN=${SLACK_OAUTH_TOKEN}
      - SLACK_TEAM_ID=${SLACK_TEAM_ID}
      - INTERNAL_SLACK_USER_ID=${INTERNAL_SLACK_USER_ID}
      - DISALLOWED_EMAIL_DOMAINS=${DISALLOWED_EMAIL_DOMAINS}
      - WEATHER_API_KEY=${WEATHER_API_KEY}
      - COMPOSIO_API_KEY=${COMPOSIO_API_KEY}
      - ALLOW_LOCAL_MCP_SERVERS=${ALLOW_LOCAL_MCP_SERVERS}
    networks:
      - tambo_network
    restart: unless-stopped
    volumes:
      - tambo_api_dist:/app/apps/api/dist
      - tambo_node_modules:/app/node_modules
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
